<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CRAN</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CRAN_files/libs/clipboard/clipboard.min.js"></script>
<script src="CRAN_files/libs/quarto-html/quarto.js"></script>
<script src="CRAN_files/libs/quarto-html/popper.min.js"></script>
<script src="CRAN_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CRAN_files/libs/quarto-html/anchor.min.js"></script>
<link href="CRAN_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CRAN_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CRAN_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CRAN_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CRAN_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-data" id="toc-the-data" class="nav-link active" data-scroll-target="#the-data">The Data</a>
  <ul>
  <li><a href="#the-zeros-issue" id="toc-the-zeros-issue" class="nav-link" data-scroll-target="#the-zeros-issue">The zeros issue</a></li>
  </ul></li>
  <li><a href="#power-law-model" id="toc-power-law-model" class="nav-link" data-scroll-target="#power-law-model">Power Law Model</a>
  <ul>
  <li><a href="#plots-of-power-law-model-fit" id="toc-plots-of-power-law-model-fit" class="nav-link" data-scroll-target="#plots-of-power-law-model-fit">Plots of Power Law Model Fit</a>
  <ul>
  <li><a href="#depends-data" id="toc-depends-data" class="nav-link" data-scroll-target="#depends-data">Depends Data</a></li>
  <li><a href="#imports-data" id="toc-imports-data" class="nav-link" data-scroll-target="#imports-data">Imports Data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#power-law-igpd-model" id="toc-power-law-igpd-model" class="nav-link" data-scroll-target="#power-law-igpd-model">Power Law-IGPD Model</a>
  <ul>
  <li><a href="#method-for-fitting" id="toc-method-for-fitting" class="nav-link" data-scroll-target="#method-for-fitting">Method for fitting</a></li>
  <li><a href="#plots-of-fitted-model" id="toc-plots-of-fitted-model" class="nav-link" data-scroll-target="#plots-of-fitted-model">Plots of fitted model</a>
  <ul>
  <li><a href="#depends-without-zeros" id="toc-depends-without-zeros" class="nav-link" data-scroll-target="#depends-without-zeros">Depends Without Zeros</a>
  <ul class="collapse">
  <li><a href="#quantile-0.95" id="toc-quantile-0.95" class="nav-link" data-scroll-target="#quantile-0.95">Quantile 0.95</a></li>
  <li><a href="#quantile-0.96" id="toc-quantile-0.96" class="nav-link" data-scroll-target="#quantile-0.96">Quantile 0.96</a></li>
  <li><a href="#quantile-0.97" id="toc-quantile-0.97" class="nav-link" data-scroll-target="#quantile-0.97">Quantile 0.97</a></li>
  <li><a href="#quantile-0.98" id="toc-quantile-0.98" class="nav-link" data-scroll-target="#quantile-0.98">Quantile 0.98</a></li>
  </ul></li>
  <li><a href="#imports-without-zeros" id="toc-imports-without-zeros" class="nav-link" data-scroll-target="#imports-without-zeros">Imports Without Zeros</a>
  <ul class="collapse">
  <li><a href="#quantile-0.95-1" id="toc-quantile-0.95-1" class="nav-link" data-scroll-target="#quantile-0.95-1">Quantile 0.95</a></li>
  <li><a href="#quantile-0.96-1" id="toc-quantile-0.96-1" class="nav-link" data-scroll-target="#quantile-0.96-1">Quantile 0.96</a></li>
  <li><a href="#quantile-0.97-1" id="toc-quantile-0.97-1" class="nav-link" data-scroll-target="#quantile-0.97-1">Quantile 0.97</a></li>
  <li><a href="#quantile-0.98-1" id="toc-quantile-0.98-1" class="nav-link" data-scroll-target="#quantile-0.98-1">Quantile 0.98</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#power-law-mixture" id="toc-power-law-mixture" class="nav-link" data-scroll-target="#power-law-mixture">Power Law Mixture</a>
  <ul>
  <li><a href="#plots-of-fitted-model-1" id="toc-plots-of-fitted-model-1" class="nav-link" data-scroll-target="#plots-of-fitted-model-1">Plots of fitted model</a>
  <ul>
  <li><a href="#depends-data-1" id="toc-depends-data-1" class="nav-link" data-scroll-target="#depends-data-1">Depends Data</a>
  <ul class="collapse">
  <li><a href="#quantile-0.95-2" id="toc-quantile-0.95-2" class="nav-link" data-scroll-target="#quantile-0.95-2">Quantile 0.95</a></li>
  <li><a href="#quantile-0.96-2" id="toc-quantile-0.96-2" class="nav-link" data-scroll-target="#quantile-0.96-2">Quantile 0.96</a></li>
  <li><a href="#quantile-0.97-2" id="toc-quantile-0.97-2" class="nav-link" data-scroll-target="#quantile-0.97-2">Quantile 0.97</a></li>
  <li><a href="#quantile-0.98-2" id="toc-quantile-0.98-2" class="nav-link" data-scroll-target="#quantile-0.98-2">Quantile 0.98</a></li>
  </ul></li>
  <li><a href="#imports-data-1" id="toc-imports-data-1" class="nav-link" data-scroll-target="#imports-data-1">Imports Data</a>
  <ul class="collapse">
  <li><a href="#quantile-0.95-3" id="toc-quantile-0.95-3" class="nav-link" data-scroll-target="#quantile-0.95-3">Quantile 0.95</a></li>
  <li><a href="#quantile-0.96-3" id="toc-quantile-0.96-3" class="nav-link" data-scroll-target="#quantile-0.96-3">Quantile 0.96</a></li>
  <li><a href="#quantile-0.97-3" id="toc-quantile-0.97-3" class="nav-link" data-scroll-target="#quantile-0.97-3">Quantile 0.97</a></li>
  <li><a href="#quantile-0.98-3" id="toc-quantile-0.98-3" class="nav-link" data-scroll-target="#quantile-0.98-3">Quantile 0.98</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a>
  <ul>
  <li><a href="#implementation-of-zeta-function" id="toc-implementation-of-zeta-function" class="nav-link" data-scroll-target="#implementation-of-zeta-function">Implementation of zeta function</a>
  <ul>
  <li><a href="#defaults" id="toc-defaults" class="nav-link" data-scroll-target="#defaults">Defaults</a></li>
  <li><a href="#increasing-the-value-of-aa-to-300" id="toc-increasing-the-value-of-aa-to-300" class="nav-link" data-scroll-target="#increasing-the-value-of-aa-to-300">Increasing the value of aa to 300</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CRAN</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="the-data" class="level1">
<h1>The Data</h1>
<p>We have data collected from the Comprehensive R Archive Network (CRAN) about the different relationships R packages have with each other. There are 4 different types of relationship:</p>
<ul>
<li><p>Imports</p></li>
<li><p>Depends</p></li>
<li><p>Linking To</p></li>
<li><p>Suggests</p></li>
</ul>
<p>We are only really interested in first two relationships. The data we will be investigating are the in-degrees of the network formed by these relationships. That is the number of other packages that either depend on or import each package.</p>
<section id="the-zeros-issue" class="level2">
<h2 class="anchored" data-anchor-id="the-zeros-issue">The zeros issue</h2>
<p>This data contains a massive amount of zeros, so much so that they have a large influence over the models to follow. So, since the zeros are mostly uninteresting, we will remove them and only investigate the non-zero data.</p>
</section>
</section>
<section id="power-law-model" class="level1">
<h1>Power Law Model</h1>
<p>We first consider modelling our data using the zeta distribution, which has probability mass function (p.m.f)</p>
<p><span class="math display">\[
f(x) = \zeta(\alpha+1)^{-1}x^{-(\alpha+1)}, \qquad x=1,2,3,\ldots
\]</span></p>
<p>and has survival function:</p>
<p><span class="math display">\[
S(x) = 1-\zeta(\alpha+1)^{-1}\sum_{k=1}^x k^{-(\alpha+1)}, \qquad x=1,2,3,\ldots
\]</span></p>
<p>Where <span class="math inline">\(\zeta(s) = \sum_{k=1}^\infty k^{-s}\)</span> is the Riemann Zeta function and <span class="math inline">\(\alpha&gt;0\)</span> .</p>
<p>If we have a vector of data <span class="math inline">\(\boldsymbol{x} = (x_1,x_2,\ldots,x_N)^T\)</span> , then the likelihood function and log-likelihood functions are:</p>
<p><span class="math display">\[
L(\boldsymbol{x}) = \zeta(\alpha+1)^{-N}\prod_{i=1}^N x_i^{-(\alpha+1)}
\]</span></p>
<p>and,</p>
<p><span class="math display">\[
\ell(\boldsymbol{x}) = -N\log\zeta(\alpha+1) - (\alpha+1)\sum_{i=1}^N\log x_i
\]</span></p>
<p>We now aim to fit this model using a Bayesian approach, which means we need to decide on a prior for <span class="math inline">\(\alpha\)</span>. Since its value is restricted to being positive we choose to use a Gamma prior, that is:</p>
<p><span class="math display">\[
\alpha \sim Ga(\gamma,\delta), \qquad \gamma,\delta &gt; 0
\]</span></p>
<p>with the prior density function being:</p>
<p><span class="math display">\[
\pi(\alpha) \propto \alpha^{\gamma-1}e^{-\delta\alpha}
\]</span></p>
<p>Now, we can calculate the posterior distribution up to a constant of proportionality:</p>
<p><span class="math display">\[
\pi(\alpha|\boldsymbol{x}) \propto\pi(\alpha)L(\boldsymbol{x})
\]</span></p>
<p>But, it will be better to use the log of the posterior distribution to mitigate any computational issues that may arise.</p>
<p><span class="math display">\[
\log\pi(\alpha|\boldsymbol{x}) = \log A + (\gamma-1)\log\alpha-N\log\zeta(\alpha+1)-\delta\alpha-(\alpha+1)\sum_{i=1}^N\log x_i
\]</span></p>
<p>Where <span class="math inline">\(A\)</span> is a normalising constant.</p>
<p>With this posterior we can fit the model to both sets of our data.</p>
<section id="plots-of-power-law-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="plots-of-power-law-model-fit">Plots of Power Law Model Fit</h2>
<p>The same prior was used for both models below, with <span class="math inline">\(\gamma = \delta = 4\)</span> . The parameters were estimated using a Metropolis-Hastings algorithm with an adaptive proposal, with initial value of <span class="math inline">\(\alpha = 2\)</span>.</p>
<section id="depends-data" class="level3">
<h3 class="anchored" data-anchor-id="depends-data">Depends Data</h3>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/Zeta%20Depends%20no%20zeros%20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="imports-data" class="level3">
<h3 class="anchored" data-anchor-id="imports-data">Imports Data</h3>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/Zeta%20Imports%20no%20zeros%20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="power-law-igpd-model" class="level1">
<h1>Power Law-IGPD Model</h1>
<p>Since the power law model seems to not fit very well, we now aim to fit a new model to the data that may fit better. This model treats the data as a power law below a certain threshold but above it the data is modeled using the integer-valued generalised Pareto distribution (IGPD). The p.m.f of this model is</p>
<p><span class="math display">\[
f(x) =
\begin{cases}
(1-\phi_u)\left[\zeta(\alpha+1)-\zeta(\alpha+1,u+1)\right]^{-1}x^{-(\alpha+1)}&amp;, x\leq u\\
\phi_u\left\{\left(1+\frac{\xi(x-u-1)}{\sigma_u}\right)_+^{-1/\xi} - \left(1+\frac{\xi (x-u)}{\sigma_u}\right)_+^{-1/\xi}\right\}&amp;,x&gt;u
\end{cases}
\]</span></p>
<p>For <span class="math inline">\(\alpha&gt;0,\xi\in\mathbb{R},\sigma_u&gt;0\)</span> with <span class="math inline">\(\xi=0\)</span> taken as the limit.</p>
<p>The cumulative mass function is given by:</p>
<p><span class="math display">\[
F(x) = \begin{cases}
(1-\phi_u)\frac{\zeta(\alpha+1)-\zeta(\alpha+1,x+1)}{\zeta(\alpha+1)-\zeta(\alpha+1,u+1)}&amp;,x\leq u\\
(1-\phi_u) + \phi_u\left[1-\left(1+\frac{\xi(x-u)}{\sigma_u}\right)_+^{-1/\xi}\right]&amp;,x&gt;u
\end{cases}
\]</span></p>
<p>Which makes the survival function of this model:</p>
<p><span class="math display">\[
S(x) =
\begin{cases}
1-(1-\phi_u)\frac{\zeta(\alpha+1)-\zeta(\alpha+1,x+1)}{\zeta(\alpha+1)-\zeta(\alpha+1,u+1)}&amp;,x\leq u\\
\phi_u\left(1+\frac{\xi(x-u)}{\sigma_u}\right)_+^{-1/\xi}&amp;,x&gt;u
\end{cases}
\]</span></p>
<p>If we have a vector of data <span class="math inline">\(\boldsymbol{x} = (x_1,x_2,\ldots x_N)^T\)</span> then the likelihood and log-likelihood are:</p>
<p><span class="math display">\[
L(\boldsymbol{x}) = (1-\phi_u)^n\phi_u^{N-n}[\zeta(\alpha+1)-\zeta(\alpha+1,u+1)]^{-n}\prod_{i:x_i \le u} x_i^{-(\alpha+1)}\prod_{i:x_i&gt;u}\left\{\left(1+\frac{\xi(x_i-u-1)}{\sigma_u}\right)_+^{-1/\xi} - \left(1+\frac{\xi (x_i-u)}{\sigma_u}\right)_+^{-1/\xi}\right\}
\]</span></p>
<p>and,</p>
<p><span class="math display">\[
\ell(\boldsymbol{x}) = n\log(1-\phi_u) + (N-n)\log\phi_u-n\log[\zeta(\alpha+1)-\zeta(\alpha+1,u+1)] -(\alpha+1)\sum_{i:x_i\leq u}\log x_i + \sum_{i:x_i&gt;u}\log\left\{\left(1+\frac{\xi(x_i-u-1)}{\sigma_u}\right)_+^{-1/\xi} - \left(1+\frac{\xi (x_i-u)}{\sigma_u}\right)_+^{-1/\xi}\right\}
\]</span></p>
<p>Since we wish to use this to construct a Metropolis-Hastings algorithm we again need some priors for the values of the parameters. The priors we use are listed below.</p>
<p><span class="math display">\[
\alpha\sim Ga(c,d),\\
\xi \sim N(0,s^2),\\
\sigma_u \sim Ga(v,w)
\]</span></p>
<p>For <span class="math inline">\(c,d,s,v,w&gt;0\)</span></p>
<p>Our joint prior distribution is defined as follows:</p>
<span class="math display">\[\begin{align}
\pi(\alpha,\xi,\sigma_u) &amp;= \pi(\alpha)\pi(\xi)\pi(\sigma_u)\\
\log\pi(\alpha,\xi\sigma_u) &amp;= \log\pi(\alpha) +\log\pi(\xi) +\log\pi(\sigma_u)
\end{align}\]</span>
<p>And we have that</p>
<span class="math display">\[\begin{align}
\log\pi(\alpha) &amp;= c\log d - \log \Gamma(c) + (c-1)\log\alpha -d\alpha\\
\log\pi(\xi) &amp;= -\log s -0.5\log 2\pi - \frac{\xi^2}{2s^2}\\
\log\pi(\sigma_u) &amp;= v\log w - \log\Gamma(v) + (v-1)\log\sigma_u - w\sigma_u
\end{align}\]</span>
<section id="method-for-fitting" class="level2">
<h2 class="anchored" data-anchor-id="method-for-fitting">Method for fitting</h2>
<p>In order to fit this model we will be using a Bayesian approach, estimating the parameters using a Metropolis-Hastings algorithm with an adaptive proposal distribution, the method is fully described below:</p>
<p>Suppose we have the initial state <span class="math inline">\(\theta^{(0)} = (\alpha^{(0)},\xi^{(0)},\sigma_u^{(0)})\)</span> and an initial proposal covariance matrix <span class="math inline">\(\Sigma^{(0)}\)</span>. Let <span class="math inline">\(\Omega\)</span> be the ordered set of accepted states that is initially empty. Starting with <span class="math inline">\(t=1\)</span>.</p>
<ol type="1">
<li><ul>
<li><p>If <span class="math inline">\(|\Omega|&lt;H\)</span> then:</p>
<ul>
<li>Set <span class="math inline">\(\Sigma^{(t)} = \Sigma^{(0)}\)</span></li>
</ul></li>
<li><p>Otherwise:</p>
<ul>
<li>Set <span class="math inline">\(\Sigma^{(t)} =\frac{2.38^2}{3}R_m\)</span> , where <span class="math inline">\(R_m\)</span> is the empirical covariance matrix of the last <span class="math inline">\(H\)</span> accepted states.</li>
</ul></li>
</ul></li>
<li><p>Propose a new state <span class="math inline">\(\theta^* \sim N(\theta^{(t-1)},\Sigma^{(t)})\)</span></p></li>
<li><ul>
<li><p>If <span class="math inline">\(\alpha^*&lt;0\)</span> or <span class="math inline">\(\sigma_u^*&lt;0\)</span> then:</p>
<ul>
<li><p>Reject: set <span class="math inline">\(\theta^{(t)} = \theta^{(t-1)}\)</span></p></li>
<li><p>Set <span class="math inline">\(t=t+1\)</span> and go to 1.</p></li>
</ul></li>
</ul></li>
<li><p>Calculate <span class="math inline">\(\mathcal{A} = \min(0,\log\pi(\theta^*|x) - \log\pi(\theta^{(t-1)}|x))\)</span></p></li>
<li><p>Draw <span class="math inline">\(z\sim U(0,1)\)</span></p>
<ul>
<li><p>If <span class="math inline">\(\log z &lt;\mathcal{A}\)</span> then:</p>
<ul>
<li><p>Accept: set <span class="math inline">\(\theta^{(t)} = \theta^*\)</span></p></li>
<li><p>Add <span class="math inline">\(\theta^{(t)}\)</span> to the end of <span class="math inline">\(\Omega\)</span></p></li>
</ul></li>
<li><p>Otherwise</p>
<ul>
<li>Reject: set <span class="math inline">\(\theta^{(t)} = \theta^{(t-1)}\)</span></li>
</ul></li>
</ul></li>
<li><p>Set <span class="math inline">\(t=t+1\)</span> and go to 1.</p></li>
</ol>
</section>
<section id="plots-of-fitted-model" class="level2">
<h2 class="anchored" data-anchor-id="plots-of-fitted-model">Plots of fitted model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>n.iter<span class="ot">=</span><span class="fl">1e4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The models below were obtained using hyper parameters:</p>
<p><span class="math display">\[
c=1,d=0.01,s=3,v=1,w=0.01
\]</span></p>
<p>The initial values used were:</p>
<p><span class="math display">\[
\alpha=2,\xi=3,\sigma_u=5
\]</span></p>
<section id="depends-without-zeros" class="level3">
<h3 class="anchored" data-anchor-id="depends-without-zeros">Depends Without Zeros</h3>
<section id="quantile-0.95" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.95">Quantile 0.95</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantile-0.96" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.96">Quantile 0.96</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantile-0.97" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.97">Quantile 0.97</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantile-0.98" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.98">Quantile 0.98</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="imports-without-zeros" class="level3">
<h3 class="anchored" data-anchor-id="imports-without-zeros">Imports Without Zeros</h3>
<section id="quantile-0.95-1" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.95-1">Quantile 0.95</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantile-0.96-1" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.96-1">Quantile 0.96</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantile-0.97-1" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.97-1">Quantile 0.97</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantile-0.98-1" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.98-1">Quantile 0.98</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="power-law-mixture" class="level1">
<h1>Power Law Mixture</h1>
<p>To see if the previous model is worth using we will compare it to a simpler model that models the data both above and below the threshold as a power law but with different parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> . The p.m.f of this model is:</p>
<p><span class="math display">\[
f(x) =
\begin{cases}
(1-\phi_u)\left[\zeta(\alpha+1) - \zeta(\alpha+1,u+1)\right]^{-1}x^{-(\alpha+1)}&amp;,x\le u\\
\phi_u\zeta(\beta+1,u+1)^{-1}x^{-(\beta+1)}&amp;,x&gt;u
\end{cases}
\]</span></p>
<p>Where <span class="math inline">\(\alpha,\beta &gt;0\)</span> and <span class="math inline">\(\phi_u \in (0,1)\)</span> is the exceedance probability, and <span class="math inline">\(\zeta(s,t) = \sum_{k=t}^\infty k^{-s}\)</span> is the Hurwitz zeta function. From now on, we will use <span class="math inline">\(\zeta_{t-1}(s)\)</span> to denote the Hurwitz zeta function with parameters <span class="math inline">\(s\)</span> and <span class="math inline">\(t\)</span> .</p>
<p>This makes the survival function of this model:</p>
<p><span class="math display">\[
S(x) =
\begin{cases}
1-(1-\phi_u)\frac{\zeta(\alpha+1)-\zeta_{x}(\alpha+1)}{\zeta(\alpha+1)-\zeta_{u}(\alpha+1)} &amp;,x\le u\\
\phi_u\frac{\zeta_{x}(\beta+1)}{\zeta_{u}(\beta+1)}&amp;,x&gt;u
\end{cases}
\]</span></p>
<p>As before we have data <span class="math inline">\(\boldsymbol{x} = (x_1,x_2,\ldots,x_N)^T\)</span> with <span class="math inline">\(n\)</span> values at or below the threshold <span class="math inline">\(u\)</span> , the likelihood function for this model is as below:</p>
<p><span class="math display">\[
L(\boldsymbol{x}) = (1-\phi_u)^n\phi_u^{N-n} \left[\zeta(\alpha+1) - \zeta_{u}(\alpha+1)\right]^{-n} \zeta_{u}(\beta+1)^{n-N} \prod_{i:x_i\le u}x_i^{-(\alpha+1)}\prod_{i:x_i&gt;u}x_i^{-(\beta+1)}
\]</span></p>
<p>and the log likelihood:</p>
<p><span class="math display">\[
\ell(\boldsymbol{x}) = n\log(1-\phi_u) + (N-n)\log\phi_u -n\log\left[\zeta(\alpha+1) - \zeta_{u}(\alpha+1)\right] + (n-N)\log\zeta_u(\beta+1) - (\alpha+1)\sum_{i:x_i \le u}{\log x_i} -(\beta+1)\sum_{i:x_i&gt;u}\log x_i
\]</span></p>
<p>We will be fitting this model using a bayesian approach and so we need to decide a prior for both <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>. We will use the same prior for <span class="math inline">\(\alpha\)</span> as we have for the last two models, and we will use the exact same prior for <span class="math inline">\(\beta\)</span> . That is:</p>
<p><span class="math display">\[
\alpha,\beta \sim Ga(\gamma,\delta)
\]</span></p>
<p>We will be treating <span class="math inline">\(\phi_u\)</span> as a fixed value, using the MLE as its value; <span class="math inline">\(\hat\phi_u = \frac{N-n}{N}\)</span></p>
<section id="plots-of-fitted-model-1" class="level2">
<h2 class="anchored" data-anchor-id="plots-of-fitted-model-1">Plots of fitted model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n.iter <span class="ot">=</span> <span class="fl">3e4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We used the hyperparamters:</p>
<p><span class="math display">\[
\gamma=1,\delta=0.01
\]</span></p>
<p>and initial values:</p>
<p><span class="math display">\[
\alpha=\beta=2
\]</span></p>
<section id="depends-data-1" class="level3">
<h3 class="anchored" data-anchor-id="depends-data-1">Depends Data</h3>
<section id="quantile-0.95-2" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.95-2">Quantile 0.95</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="quantile-0.96-2" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.96-2">Quantile 0.96</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="quantile-0.97-2" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.97-2">Quantile 0.97</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="quantile-0.98-2" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.98-2">Quantile 0.98</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
</section>
<section id="imports-data-1" class="level3">
<h3 class="anchored" data-anchor-id="imports-data-1">Imports Data</h3>
<section id="quantile-0.95-3" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.95-3">Quantile 0.95</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="quantile-0.96-3" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.96-3">Quantile 0.96</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="quantile-0.97-3" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.97-3">Quantile 0.97</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
<section id="quantile-0.98-3" class="level4">
<h4 class="anchored" data-anchor-id="quantile-0.98-3">Quantile 0.98</h4>
<div class="cell quarto-layout-panel" data-fig.ncol="2">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="CRAN_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="notes" class="level1">
<h1>Notes</h1>
<section id="implementation-of-zeta-function" class="level2">
<h2 class="anchored" data-anchor-id="implementation-of-zeta-function">Implementation of zeta function</h2>
<p>Below is a plot demonstrating the difference in the values obtained from the two different implementations of the hurwitz zeta function.There appears to be a large difference, with the gsl library being more accurate, evidenced by the fact that we can increase the ‘aa’ variable in the function from VGAM and obtain values closer to those obtained from gsl.</p>
<section id="defaults" class="level3">
<h3 class="anchored" data-anchor-id="defaults">Defaults</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>zeta_mod <span class="ot">=</span> <span class="cf">function</span> (x, <span class="at">deriv =</span> <span class="dv">0</span>, <span class="at">shift =</span> <span class="dv">1</span>,<span class="at">aa=</span><span class="dv">12</span>) </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    deriv.arg <span class="ot">&lt;-</span> deriv</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(deriv)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.Numeric</span>(deriv.arg, <span class="at">length.arg =</span> <span class="dv">1</span>, <span class="at">integer.valued =</span> <span class="cn">TRUE</span>)) </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"'deriv' must be a single non-negative integer"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (deriv.arg <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">||</span> deriv.arg <span class="sc">&gt;</span> <span class="dv">2</span>) </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"'deriv' must be 0, 1, or 2"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (deriv.arg <span class="sc">&gt;</span> <span class="dv">0</span>) </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">zeta.specials</span>(<span class="fu">Zeta.derivative</span>(x, <span class="at">deriv.arg =</span> deriv.arg, </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">shift =</span> shift), x, deriv.arg, shift))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(special <span class="ot">&lt;-</span> <span class="fu">Re</span>(x) <span class="sc">&lt;=</span> <span class="dv">1</span>)) {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        ans <span class="ot">&lt;-</span> x</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        ans[special] <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        special3 <span class="ot">&lt;-</span> <span class="fu">Re</span>(x) <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        ans[special3] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        special4 <span class="ot">&lt;-</span> (<span class="dv">0</span> <span class="sc">&lt;</span> <span class="fu">Re</span>(x)) <span class="sc">&amp;</span> (<span class="fu">Re</span>(x) <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (<span class="fu">Im</span>(x) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        ans[special4] <span class="ot">&lt;-</span> <span class="fu">Zeta.derivative</span>(x[special4], <span class="at">deriv.arg =</span> deriv.arg, </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">shift =</span> shift)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        special2 <span class="ot">&lt;-</span> <span class="fu">Re</span>(x) <span class="sc">&lt;</span> <span class="dv">0</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">any</span>(special2)) {</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            x2 <span class="ot">&lt;-</span> x[special2]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>            cx <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> x2</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>            ans[special2] <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span>(x2) <span class="sc">*</span> pi<span class="sc">^</span>(x2 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">sin</span>(pi <span class="sc">*</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                x2<span class="sc">/</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">gamma</span>(cx) <span class="sc">*</span> <span class="fu">Recall</span>(cx)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>special)) {</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            ans[<span class="sc">!</span>special] <span class="ot">&lt;-</span> <span class="fu">Recall</span>(x[<span class="sc">!</span>special])</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">zeta.specials</span>(ans, x, deriv.arg, shift))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    ans <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>(aa <span class="sc">-</span> <span class="dv">1</span>)) ans <span class="ot">&lt;-</span> ans <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>(shift <span class="sc">+</span> ii)<span class="sc">^</span>x</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    ans <span class="ot">&lt;-</span> ans <span class="sc">+</span> <span class="fu">Zeta.aux</span>(<span class="at">shape =</span> x, aa, <span class="at">shift =</span> shift)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    ans[shift <span class="sc">&lt;=</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NaN</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">zeta.specials</span>(ans, x, <span class="at">deriv.arg =</span> deriv.arg, <span class="at">shift =</span> shift)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="increasing-the-value-of-aa-to-300" class="level3">
<h3 class="anchored" data-anchor-id="increasing-the-value-of-aa-to-300">Increasing the value of aa to 300</h3>
<div class="cell">
<div class="cell-output-display">
<p><img src="CRAN_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>